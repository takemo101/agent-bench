# 表示改善機能 要件定義書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | REQ-CLI-004 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-10 |
| 最終更新日 | 2026-01-10 |
| 作成者 | - |
| 承認者 | - |
| 親要件 | REQ-CLI-001 |
| 関連要件 | REQ-CLI-002 (F-024 インジケーター表示) |

---

## 1. 概要

### 1.1 背景

既存のポモドーロタイマーCLI（REQ-CLI-001, REQ-CLI-002）では、残り時間の表示は基本的なプログレスバーと`MM:SS / MM:SS`形式で提供されている。ユーザーからのフィードバックにより、以下の改善要望が寄せられた：

1. **時間表示フォーマットの改善**: 経過時間/目標時間（パーセンテージ%）形式で、進捗をより直感的に把握したい
2. **視覚的なフェーズ表現**: 作業中/休憩中/長期休憩中の状態を、アニメーションで動的に表現したい
3. **ターミナル幅の活用**: アニメーションをターミナルの横幅に広げ、視覚的なインパクトを向上させたい

### 1.2 目的

本要件は、ポモドーロタイマーCLIの表示機能を改善し、ユーザー体験を向上させることを目的とする：

1. **進捗の直感的把握**: 経過時間/目標時間（パーセンテージ）形式で残り時間を表示
2. **状態の視覚化**: フェーズに応じたASCIIアニメーションで作業/休憩状態を動的に表現
3. **没入感の向上**: ターミナル幅を活用したアニメーションで、集中作業を支援

### 1.3 ゴール

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| 時間把握速度 | 2秒以内で進捗を把握 | ユーザーテスト |
| 状態識別率 | 99%以上 | アニメーションでフェーズを正しく識別できるか |
| アニメーション滑らかさ | ちらつきなし | 手動テスト |
| CPU追加負荷 | 1%以下 | プロセスモニタでの測定 |

### 1.4 スコープ

#### 対象範囲（Phase 1）
- 時間表示フォーマットの改善（mm:ss/mm:ss (per%)形式）
- フェーズ別ASCIIアニメーション（作業中/休憩中/長期休憩中）
- 統合レイアウト（インジケーター＋時間＋アニメーション＋タスク名）
- ちらつき防止処理

#### 対象外（Phase 2以降）
- アニメーションのカスタマイズ（ユーザー定義アニメーション）
- アニメーション速度の調整オプション
- カラースキームのカスタマイズ
- アニメーション無効化オプション

---

## 2. ステークホルダー

REQ-CLI-001 セクション2.1を参照。本要件に特有のステークホルダーは追加なし。

---

## 3. 機能要件

### 3.1 機能一覧

| ID | 機能名 | 概要 | 優先度 | フェーズ | 親機能 |
|----|--------|------|--------|---------|--------|
| F-035 | 時間表示フォーマット改善 | 経過時間/目標時間（パーセンテージ%）形式で表示 | 必須 | Phase 1 | F-024 |
| F-036 | フェーズ別アニメーション | 作業中/休憩中/長期休憩中でASCIIアニメーションを表示 | 必須 | Phase 1 | F-024 |
| F-037 | 統合レイアウト | インジケーター、時間、アニメーション、タスク名を統合表示 | 必須 | Phase 1 | F-024 |

### 3.2 ユーザーストーリー

#### US-016: 進捗の直感的な把握

- **ユーザー**: ターミナル常駐開発者
- **したいこと**: 経過時間と目標時間、パーセンテージを一目で把握したい
- **理由**: 残り時間だけでなく、どれだけ進んだかを直感的に知りたい
- **受け入れ基準**:
  - [ ] 時間が`05:23/25:00 (21%)`形式で表示される
  - [ ] パーセンテージは経過時間に基づいて計算される
  - [ ] 1秒ごとに更新される
- **関連機能**: F-035

#### US-017: フェーズの視覚的な識別

- **ユーザー**: macOSパワーユーザー
- **したいこと**: 作業中か休憩中かをアニメーションで直感的に識別したい
- **理由**: テキストだけでなく、動きで状態を把握したい
- **受け入れ基準**:
  - [ ] 作業中は走っている人のアニメーションが表示される
  - [ ] 休憩中はストレッチしている人のアニメーションが表示される
  - [ ] 長期休憩中は寝ている人のアニメーションが表示される
  - [ ] アニメーションはターミナル幅の20-40文字を使用する
- **関連機能**: F-036

#### US-018: 統一された表示レイアウト

- **ユーザー**: マルチタスク在宅ワーカー
- **したいこと**: すべての情報を整理された1つのビューで確認したい
- **理由**: 複数の情報が散らばっていると見づらい
- **受け入れ基準**:
  - [ ] 1行目: フェーズアイコン＋ステータス＋インジケーター＋時間表示
  - [ ] 2行目: アニメーション
  - [ ] 3行目: タスク名
  - [ ] 表示がちらつかない
- **関連機能**: F-037

### 3.3 機能詳細

#### F-035: 時間表示フォーマット改善

**概要**: 残り時間を`経過時間/目標時間 (パーセンテージ%)`形式で表示する

**入力**:
- 現在の経過時間（秒）
- 目標時間（秒）

**出力**:
- フォーマット済み時間文字列: `MM:SS/MM:SS (PP%)`

**処理概要**:
1. 経過時間をMM:SS形式にフォーマット
2. 目標時間をMM:SS形式にフォーマット
3. パーセンテージを計算: `(経過時間 / 目標時間) * 100`
4. 小数点以下を切り捨てて整数パーセンテージを表示
5. 結合して`05:23/25:00 (21%)`形式で出力

**表示例**:
```
作業開始直後:  00:00/25:00 (0%)
作業中盤:      12:30/25:00 (50%)
作業終了直前:  24:59/25:00 (99%)
休憩中:        02:30/05:00 (50%)
長期休憩中:    07:30/15:00 (50%)
```

**ビジネスルール**:
- BR-090: 時間表示は常に`MM:SS/MM:SS (PP%)`形式とする
- BR-091: パーセンテージは0-100の整数値で表示（小数点なし）
- BR-092: 経過時間が目標時間を超えた場合は100%と表示
- BR-093: 分は2桁でゼロパディング、秒も2桁でゼロパディング

**制約事項**:
- 時間表示の最大幅は20文字（`00:00/00:00 (100%)`）

---

#### F-036: フェーズ別アニメーション

**概要**: 現在のフェーズに応じたASCIIアートアニメーションを表示する

**入力**:
- 現在のフェーズ（作業中/短い休憩/長い休憩）
- 現在のフレーム番号

**出力**:
- フェーズに対応するASCIIアートフレーム

**処理概要**:
1. フェーズに対応するアニメーションフレームセットを取得
2. フレームカウンタに基づいて現在のフレームを選択
3. フレームを描画（横幅30文字程度）
4. フレームカウンタをインクリメント（ループ）

**アニメーション定義**:

##### 作業中アニメーション（走っている人）- 4フレーム

```
フレーム1:
    🏃
   ╱│╲     ════════════════════════════
   ╱ ╲     ════════════════════════════

フレーム2:
    🏃
    │╲     ═════════════════════════════
   ─┘ ╲    ═════════════════════════════

フレーム3:
    🏃
   ╲│      ══════════════════════════════
   ╱ └─    ══════════════════════════════

フレーム4:
    🏃
   ╲│╱     ═══════════════════════════════
   ╲ ╱     ═══════════════════════════════
```

**簡易版（推奨実装）**:
```
フレーム1:  🏃💨 ─────────────────────────────
フレーム2:   🏃💨 ────────────────────────────
フレーム3:    🏃💨 ───────────────────────────
フレーム4:     🏃💨 ──────────────────────────
```

##### 休憩中アニメーション（ストレッチしている人）- 4フレーム

```
フレーム1:  🧘 ～～～ ゆっくり休憩中 ～～～
フレーム2:  🧘  ～～～ ゆっくり休憩中 ～～～
フレーム3:  🧘 ～～～  ゆっくり休憩中 ～～～
フレーム4:  🧘  ～～～ ゆっくり休憩中  ～～～
```

##### 長期休憩中アニメーション（寝ている人）- 2フレーム

```
フレーム1:  😴💤 zzz... ───────────────────
フレーム2:  😴💤  zzz... ──────────────────
```

**ビジネスルール**:
- BR-094: アニメーションは200ms間隔で更新（5 FPS）
- BR-095: 作業中アニメーションは4フレームでループ
- BR-096: 休憩中アニメーションは4フレームでループ
- BR-097: 長期休憩中アニメーションは2フレームでループ
- BR-098: アニメーションの横幅は30-40文字を使用
- BR-099: アニメーションはターミナル幅に収まるように調整（最小幅80文字想定）

**制約事項**:
- ターミナル幅が80文字未満の場合はアニメーションを簡略化
- 絵文字非対応ターミナルでは代替ASCII文字を使用

---

#### F-037: 統合レイアウト

**概要**: インジケーター、時間表示、アニメーション、タスク名を統合したレイアウトで表示する

**入力**:
- 現在のフェーズ
- 残り時間
- 目標時間
- 現在のアニメーションフレーム
- タスク名（オプション）

**出力**:
- 統合されたターミナル表示（3行）

**処理概要**:
1. 1行目を構築: フェーズアイコン＋ステータス＋インジケーター＋時間表示
2. 2行目を構築: アニメーションフレーム
3. 3行目を構築: タスク名（設定されている場合）
4. カーソル制御でちらつきを防止しながら描画

**表示レイアウト**:

```
🍅 作業中 ████████░░░░░░░░░░░░ 05:23/25:00 (21%)
🏃💨 ─────────────────────────────
タスク: 書類作成
```

```
☕ 休憩中 ██████░░░░░░░░░░░░░░ 02:30/05:00 (50%)
🧘 ～～～ ゆっくり休憩中 ～～～
```

```
🛏️ 長期休憩中 ████████░░░░░░░░░░░░ 07:30/15:00 (50%)
😴💤 zzz... ───────────────────
```

**ビジネスルール**:
- BR-100: 1行目は常に表示（フェーズ＋インジケーター＋時間）
- BR-101: 2行目はアニメーション専用行
- BR-102: 3行目はタスク名がある場合のみ表示
- BR-103: 各行の更新は独立して行い、ちらつきを防止
- BR-104: カーソル位置を保存・復元してスムーズな更新を実現

**制約事項**:
- 最小ターミナル幅: 80文字
- 最小ターミナル高さ: 5行
- ANSIエスケープシーケンス対応必須

---

## 4. 非機能要件

### 4.1 性能要件

| ID | 要件 | 目標値 | 測定方法 |
|----|------|--------|----------|
| NFR-P-020 | アニメーション更新頻度 | 5 FPS（200ms間隔） | フレームカウンタログ |
| NFR-P-021 | アニメーション時CPU追加負荷 | 1%以下 | プロセスモニタ（Activity Monitor） |
| NFR-P-022 | 画面更新遅延 | 50ms以内 | タイマー測定 |
| NFR-P-023 | メモリ追加使用量 | 1MB以下 | プロセスモニタ |

### 4.2 ユーザビリティ要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-U-020 | ちらつき防止 | ダブルバッファリングまたはカーソル制御でちらつきを完全に防止 |
| NFR-U-021 | 文字幅計算 | 全角文字（絵文字含む）と半角文字の幅を正しく計算 |
| NFR-U-022 | フォールバック表示 | 絵文字非対応ターミナルでは代替ASCII文字を使用 |
| NFR-U-023 | ターミナル幅対応 | 80文字未満の場合は簡略表示に自動切り替え |

### 4.3 ちらつき防止実装方式

```
方式: ANSIエスケープシーケンスによるカーソル制御

1. 更新開始時:
   - カーソル位置を保存 (\x1b[s)
   - カーソルを非表示に (\x1b[?25l)

2. 描画処理:
   - 各行をカーソル移動で上書き (\x1b[<n>A で n行上に移動)
   - 行全体をクリア (\x1b[2K)
   - 新しい内容を描画

3. 更新完了時:
   - カーソル位置を復元 (\x1b[u)
   - カーソルを表示 (\x1b[?25h)
```

---

## 5. 制約条件

### 5.1 技術的制約

| 制約 | 詳細 | 理由 |
|------|------|------|
| ターミナル | ANSIエスケープシーケンス対応必須 | カーソル制御・色分けのため |
| 最小ターミナル幅 | 80文字以上 | アニメーション表示のため |
| 絵文字サポート | Unicode対応ターミナル推奨 | フェーズアイコン表示のため |
| 依存クレート | indicatif 0.18+, colored 3.0+ | 既存依存関係との整合性 |

### 5.2 ビジネス制約

REQ-CLI-001 セクション5.2を参照。

---

## 6. 外部インターフェース

### 6.1 ターミナルインターフェース

| 項目 | 内容 |
|------|------|
| 出力先 | 標準出力 (stdout) |
| 制御方式 | ANSIエスケープシーケンス |
| 更新方式 | インプレース更新（同一行上書き） |

### 6.2 使用するANSIエスケープシーケンス

| シーケンス | 説明 |
|-----------|------|
| `\x1b[s` | カーソル位置保存 |
| `\x1b[u` | カーソル位置復元 |
| `\x1b[?25l` | カーソル非表示 |
| `\x1b[?25h` | カーソル表示 |
| `\x1b[<n>A` | カーソルをn行上に移動 |
| `\x1b[2K` | 現在行をクリア |
| `\x1b[<n>G` | カーソルをn列目に移動 |

---

## 7. 前提条件と依存関係

### 7.1 前提条件

- REQ-CLI-001, REQ-CLI-002の基本機能（F-024）が実装済み
- ターミナルがANSIエスケープシーケンスに対応している
- ターミナルがUnicode（絵文字）表示に対応している（推奨）

### 7.2 依存関係

| 依存先 | 内容 | 影響 |
|--------|------|------|
| REQ-CLI-002 F-024 | インジケーター表示 | 本機能で拡張 |
| indicatif クレート | プログレスバー描画 | 既存依存関係 |
| colored クレート | 色分け表示 | 既存依存関係 |

---

## 8. リスクと課題

### 8.1 リスク一覧

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| R-020 | ターミナル互換性問題 | 中 | 中 | Terminal.app, iTerm2での動作確認優先 |
| R-021 | 絵文字表示の文字幅計算誤り | 中 | 中 | unicode-widthクレートの使用を検討 |
| R-022 | アニメーションによるCPU負荷増加 | 低 | 低 | FPSを5に制限、必要に応じて調整 |
| R-023 | 画面のちらつき | 高 | 中 | ダブルバッファリング・カーソル制御の実装 |

### 8.2 未解決課題

| ID | 課題 | 担当 | 期限 | ステータス |
|----|------|------|------|----------|
| I-020 | 絵文字幅計算の検証（iTerm2, Terminal.app） | - | 2026-01-15 | 未着手 |
| I-021 | アニメーションFPS最適値の検証 | - | 2026-01-15 | 未着手 |
| I-022 | indicatifとの統合方式の検討 | - | 2026-01-12 | 未着手 |

---

## 9. 用語集

| 用語 | 定義 |
|------|------|
| ASCIIアート | 文字や記号を使って絵を描く表現手法 |
| アニメーションフレーム | アニメーションを構成する1コマ |
| FPS | Frames Per Second（1秒あたりのフレーム数） |
| ダブルバッファリング | 描画のちらつきを防ぐため、裏画面に描画してから表示を切り替える手法 |
| ANSIエスケープシーケンス | ターミナルの色やカーソル位置を制御する特殊文字列 |
| インプレース更新 | 同じ位置を上書きして表示を更新する方式 |
| 全角文字 | 表示幅が2文字分の文字（日本語、絵文字等） |
| 半角文字 | 表示幅が1文字分の文字（ASCII文字等） |

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-10 | 初版作成：時間表示フォーマット改善、フェーズ別アニメーション、統合レイアウトを定義 | - |

---

## 付録A: 表示サンプル

### A.1 作業中の表示

```
🍅 作業中 ████████░░░░░░░░░░░░ 05:23/25:00 (21%)
🏃💨 ─────────────────────────────
タスク: 書類作成
```

### A.2 休憩中の表示

```
☕ 休憩中 ██████░░░░░░░░░░░░░░ 02:30/05:00 (50%)
🧘 ～～～ ゆっくり休憩中 ～～～
```

### A.3 長期休憩中の表示

```
🛏️ 長期休憩中 ████████░░░░░░░░░░░░ 07:30/15:00 (50%)
😴💤 zzz... ───────────────────
```

### A.4 一時停止中の表示

```
⏸️ 一時停止 ████████░░░░░░░░░░░░ 05:23/25:00 (21%)
   （一時停止中）
タスク: 書類作成
```

---

## 付録B: 実装ガイドライン

### B.1 アニメーション更新ループ

```rust
// 擬似コード
const ANIMATION_INTERVAL_MS: u64 = 200; // 5 FPS

async fn animation_loop(state: Arc<TimerState>) {
    let mut frame_counter: usize = 0;
    let mut interval = tokio::time::interval(Duration::from_millis(ANIMATION_INTERVAL_MS));
    
    loop {
        interval.tick().await;
        
        let phase = state.current_phase();
        let frames = get_animation_frames(phase);
        let current_frame = &frames[frame_counter % frames.len()];
        
        render_display(state.clone(), current_frame);
        frame_counter = frame_counter.wrapping_add(1);
    }
}
```

### B.2 時間フォーマット関数

```rust
// 擬似コード
fn format_time_display(elapsed_secs: u64, total_secs: u64) -> String {
    let elapsed_mm = elapsed_secs / 60;
    let elapsed_ss = elapsed_secs % 60;
    let total_mm = total_secs / 60;
    let total_ss = total_secs % 60;
    let percent = if total_secs > 0 {
        (elapsed_secs * 100 / total_secs).min(100)
    } else {
        0
    };
    
    format!("{:02}:{:02}/{:02}:{:02} ({}%)", 
            elapsed_mm, elapsed_ss, total_mm, total_ss, percent)
}
```

---

**要件定義書の作成完了**

このドキュメントは、プロジェクトの進行に伴い更新される可能性があります。変更がある場合は、変更履歴セクションに記録してください。
