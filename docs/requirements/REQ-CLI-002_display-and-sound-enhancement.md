# 表示とサウンド機能強化 要件定義書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | REQ-CLI-002 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-05 |
| 最終更新日 | 2026-01-05 |
| 作成者 | - |
| 承認者 | - |
| 親要件 | REQ-CLI-001 |

---

## 1. 概要

### 1.1 背景

既存のポモドーロタイマーCLI（REQ-CLI-001）では、残り時間の表示は基本的なプログレスバー形式であり、タイマー完了時のサウンドは単一の通知音（Glass）を使用している。ユーザーからのフィードバックにより、以下の改善要望が寄せられた：

1. **視覚的な改善**: 残り時間をより直感的でデザイン性の高いインジケーターで表示したい
2. **サウンドの差別化**: 作業終了と休憩終了を異なるサウンドで区別し、状態遷移を直感的に把握したい
3. **macOSネイティブ体験**: macOSに標準搭載されているシステムサウンドを活用し、統一感のある体験を提供したい

### 1.2 目的

本要件は、ポモドーロタイマーCLIの表示とサウンド機能を強化し、ユーザー体験を向上させることを目的とする：

1. **視認性の向上**: デザイン性の高いインジケーターで残り時間を視覚的に伝える
2. **状態識別の向上**: フェーズ（作業/休憩）ごとに異なるサウンドで終了を通知
3. **カスタマイズ性**: ユーザーが好みのサウンドを選択可能にする
4. **macOS統合**: システムサウンドを活用したネイティブな体験

### 1.3 ゴール

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| サウンド識別率 | 95%以上 | ユーザーが作業/休憩終了を正しく識別できるか |
| インジケーター視認性 | 3秒以内で残り時間を把握 | ユーザーテスト |
| サウンド再生遅延 | 100ms以内 | タイマー完了からサウンド再生開始までの時間 |
| ユーザー満足度 | 4/5以上 | アンケート調査 |

### 1.4 スコープ

#### 対象範囲（Phase 1）
- デザイン性の高いインジケーター表示
- 残り秒数の併記表示
- フェーズ別サウンド（作業終了/休憩終了）
- サウンド選択機能（macOSシステムサウンドから選択）
- 作業/休憩の色分け表示

#### 対象外（Phase 2以降）
- インジケータースタイル選択（円形、線形など複数スタイル）
- アニメーション効果（フェードイン/アウト、パルス等）
- カスタムサウンドファイル対応（ユーザー独自のサウンド）
- 音量調整機能
- インジケーターの詳細カスタマイズ（色、サイズ等）
- プレビュー機能

### 1.5 前提条件（スコープ拡張）

本要件は以下の既存設計を拡張する：

| 既存設計書 | 拡張内容 | 影響度 |
|-----------|---------|--------|
| DETAILED-CLI-001-SOUND (サウンド再生詳細設計) | フェーズ別サウンド対応に拡張 | 高 |
| DETAILED-CLI-001-CLIENT (CLIクライアント詳細設計) | `sounds`/`config` コマンド追加 | 高 |
| BASIC-CLI-001 (基本設計書) | 設定永続化を部分的にPhase 1で実装 | 中 |

> **重要**: 本要件の実装前に、上記詳細設計書の更新が必要です。

---

## 2. ステークホルダー

### 2.1 ステークホルダー一覧

REQ-CLI-001 セクション2.1を参照。本要件に特有のステークホルダーは追加なし。

### 2.2 ユーザーペルソナ

REQ-CLI-001 セクション2.2を参照。本要件は全ペルソナに共通して適用される。

---

## 3. 機能要件

### 3.1 機能一覧

| ID | 機能名 | 概要 | 優先度 | フェーズ | 親機能 |
|----|--------|------|--------|---------|--------|
| F-024 | インジケーター表示 | 残り時間をデザイン性の高いインジケーターで表示 | 必須 | Phase 1 | F-004 |
| F-025 | フェーズ別サウンド | 作業終了/休憩終了で異なるサウンドを再生 | 必須 | Phase 1 | F-021 |
| F-026 | サウンド選択 | ユーザーがサウンドを選択可能 | 重要 | Phase 1 | F-025 |
| F-027 | 色分け表示 | 作業中/休憩中で表示色を変更 | 重要 | Phase 1 | F-024 |

### 3.2 ユーザーストーリー

#### US-012: デザイン性の高い残り時間表示

- **ユーザー**: macOSパワーユーザー
- **したいこと**: 残り時間を視覚的に美しいインジケーターで確認したい
- **理由**: 単純なプログレスバーよりも直感的に残り時間を把握したい
- **受け入れ基準**:
  - [ ] 残り時間がインジケーター形式で表示される
  - [ ] 残り秒数（MM:SS）も併記される
  - [ ] インジケーターは進捗に応じて視覚的に変化する
  - [ ] デザインが洗練されている（ブロック形式、グラデーション等）
- **関連機能**: F-024

#### US-013: フェーズ別サウンドによる状態識別

- **ユーザー**: マルチタスク在宅ワーカー
- **したいこと**: 作業終了と休憩終了を異なるサウンドで区別したい
- **理由**: 画面を見ていなくても、サウンドだけで状態を把握したい
- **受け入れ基準**:
  - [ ] 作業終了時にアラート系サウンド（Funk, Pop等）が再生される
  - [ ] 休憩終了時にリラックス系サウンド（Glass, Basso等）が再生される
  - [ ] サウンドが明確に異なり、聞き分けられる
- **関連機能**: F-025

#### US-014: サウンドのカスタマイズ

- **ユーザー**: ターミナル常駐開発者
- **したいこと**: 自分好みのサウンドを選択したい
- **理由**: デフォルトのサウンドが好みではない場合がある
- **受け入れ基準**:
  - [ ] 利用可能なmacOSシステムサウンドの一覧が表示される
  - [ ] 作業終了サウンドを選択できる
  - [ ] 休憩終了サウンドを選択できる
  - [ ] 選択したサウンドが次回以降も適用される
- **関連機能**: F-026

#### US-015: 色による状態識別

- **ユーザー**: macOSパワーユーザー
- **したいこと**: 作業中と休憩中で表示色が変わってほしい
- **理由**: 一目で現在の状態を把握したい
- **受け入れ基準**:
  - [ ] 作業中は暖色系（赤、オレンジ等）で表示される
  - [ ] 休憩中は寒色系（青、緑等）で表示される
  - [ ] 色の変化が直感的で視認性が高い
- **関連機能**: F-027

### 3.3 機能詳細

#### F-024: インジケーター表示

**概要**: 残り時間をデザイン性の高いインジケーター形式で表示する

**入力**:
- 現在の残り時間（秒）
- 総時間（秒）
- タイマーの種類（作業/短い休憩/長い休憩）

**出力**:
- 視覚的なインジケーター
- 残り時間（MM:SS形式）
- 進捗パーセンテージ

**表示例**:
```
🍅 ポモドーロ #1 - 作業中

  ████████████████████░░░░░░░░░░  15:30 / 25:00 (62%)

  タスク: API実装
```

または円形風表示:
```
🍅 ポモドーロ #1 - 作業中

  ◉◉◉◉◉◉◉◉◉◉◉◉○○○○○○○○  15:30 残り

  タスク: API実装
```

**処理概要**:
1. 残り時間と総時間から進捗率を計算
2. 進捗率に応じてインジケーターを描画
3. 残り時間をMM:SS形式でフォーマット
4. フェーズに応じた色を適用（F-027と連携）
5. 1秒ごとに画面を更新（同一行上書き）

**ビジネスルール**:
- BR-052: インジケーターは最低20文字幅で表示
- BR-053: 残り時間はMM:SS形式で常に表示
- BR-054: インジケーターは塗りつぶし部分と未塗りつぶし部分で視覚的に区別
- BR-055: 更新時のちらつきを防止するため、カーソル制御を使用

**制約事項**:
- ターミナル幅が狭い場合はシンプル表示にフォールバック
- ANSIエスケープシーケンス非対応環境では色なしで表示

---

#### F-025: フェーズ別サウンド

**概要**: タイマー完了時にフェーズに応じた異なるサウンドを再生する

**入力**:
- タイマー完了イベント
- フェーズ種別（作業終了/休憩終了）

**出力**:
- macOSシステムサウンドの再生

**処理概要**:
1. タイマー完了を検知
2. フェーズ種別を判定
3. フェーズに対応するサウンド設定を取得
4. `/System/Library/Sounds/` からサウンドファイルを読み込み
5. rodioを使用してサウンドを再生

**サウンドマッピング（デフォルト）**:

| フェーズ | 用途 | デフォルトサウンド | 代替候補 |
|---------|------|------------------|---------|
| 作業終了 | 休憩開始の合図 | Funk | Pop, Ping, Hero |
| 短い休憩終了 | 作業再開の合図 | Glass | Basso, Purr |
| 長い休憩終了 | 作業再開の合図 | Glass | Basso, Purr |

**ビジネスルール**:
- BR-056: 作業終了サウンドは短く明確なアラート音とする
- BR-057: 休憩終了サウンドは穏やかでリラックス系とする
- BR-058: サウンドファイルが見つからない場合は埋め込みサウンドにフォールバック
- BR-059: サウンド再生はタイマー完了から100ms以内に開始

**制約事項**:
- macOSシステムサウンドは `/System/Library/Sounds/` に存在するものに限定
- システムサウンド無効時は再生されない（警告ログのみ）

---

#### F-026: サウンド選択

**概要**: ユーザーが作業終了/休憩終了のサウンドを選択可能にする

**入力**:
- `pomodoro config --work-sound <サウンド名>`: 作業終了サウンド設定
- `pomodoro config --break-sound <サウンド名>`: 休憩終了サウンド設定
- `pomodoro sounds`: 利用可能なサウンド一覧表示

**出力**:
- 設定の保存
- 利用可能なサウンド一覧

**処理概要**:
1. `/System/Library/Sounds/` をスキャンして利用可能なサウンドを取得
2. ユーザー指定のサウンドが存在するか検証
3. 設定をファイルに保存（`~/.pomodoro/config.toml` または環境変数）
4. タイマー完了時に設定されたサウンドを使用

**コマンド例**:
```bash
# 利用可能なサウンド一覧
pomodoro sounds

# 出力例:
# 利用可能なサウンド:
#   - Basso
#   - Blow
#   - Bottle
#   - Frog
#   - Funk
#   - Glass
#   - Hero
#   - Morse
#   - Ping
#   - Pop
#   - Purr
#   - Sosumi
#   - Submarine
#   - Tink

# 作業終了サウンドを設定
pomodoro config --work-sound Pop

# 休憩終了サウンドを設定
pomodoro config --break-sound Basso

# 現在の設定を確認
pomodoro config --show
```

**ビジネスルール**:
- BR-060: 存在しないサウンド名を指定した場合はエラー
- BR-061: 設定は永続化され、次回起動時も適用
- BR-062: `--no-sound` オプションでサウンドを無効化可能（既存機能）

**制約事項**:
- カスタムサウンドファイルの指定はPhase 2
- 音量調整はPhase 2

---

#### F-027: 色分け表示

**概要**: 作業中と休憩中で表示色を変更し、状態を視覚的に区別する

**入力**:
- 現在のフェーズ（作業中/短い休憩/長い休憩）

**出力**:
- フェーズに応じた色付きの表示

**カラースキーム**:

| フェーズ | 色 | ANSIカラーコード | 意味 |
|---------|-----|-----------------|------|
| 作業中 | 赤/オレンジ | `\x1b[31m` または `\x1b[33m` | 集中、アクティブ |
| 短い休憩 | 緑 | `\x1b[32m` | リラックス、回復 |
| 長い休憩 | 青 | `\x1b[34m` | 深いリラックス |
| 一時停止 | 黄色 | `\x1b[33m` | 待機状態 |

**表示例**:
```
作業中（赤色）:
🍅 ポモドーロ #1 - 作業中
  [赤] ████████████████████░░░░░░░░░░  15:30 / 25:00

休憩中（緑色）:
☕ 休憩中
  [緑] ██████░░░░░░░░░░░░░░░░░░░░░░░░  02:30 / 05:00
```

**ビジネスルール**:
- BR-063: 作業中は暖色系（赤/オレンジ）で表示
- BR-064: 休憩中は寒色系（緑/青）で表示
- BR-065: 一時停止中は黄色で表示
- BR-066: 色は256色対応ターミナルで最適表示、非対応環境では基本8色にフォールバック

**制約事項**:
- ANSIカラー非対応ターミナルでは色なしで表示
- 色のカスタマイズはPhase 2

---

## 4. 非機能要件

### 4.1 性能要件

| ID | 要件 | 目標値 | 測定方法 |
|----|------|--------|----------|
| NFR-P-010 | サウンド再生遅延 | 100ms以内 | タイマー完了からサウンド開始までの時間 |
| NFR-P-011 | インジケーター更新 | 1秒ごと、ちらつきなし | 手動テスト |
| NFR-P-012 | サウンドファイル読み込み | 50ms以内 | ファイルI/O時間の測定 |
| NFR-P-013 | 追加メモリ使用量 | 5MB以内 | プロセスモニタでの測定 |

### 4.2 ユーザビリティ要件

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-U-010 | サウンド識別性 | 作業終了と休憩終了のサウンドが明確に区別できる |
| NFR-U-011 | 視認性 | インジケーターが3秒以内に残り時間を把握できる |
| NFR-U-012 | 一貫性 | macOSのシステムサウンドを使用し、ネイティブ体験を提供 |

---

## 5. 制約条件

### 5.1 技術的制約

| 制約 | 詳細 | 理由 |
|------|------|------|
| サウンドライブラリ | rodio（既存依存関係） | 既存実装との整合性 |
| サウンドフォーマット | AIFF（macOSシステムサウンド） | macOS標準形式 |
| サウンドパス | `/System/Library/Sounds/` | macOSシステムサウンドの標準パス |
| ターミナル | ANSIエスケープシーケンス対応 | 色分け表示のため |

### 5.2 ビジネス制約

REQ-CLI-001 セクション5.2を参照。

### 5.3 設定永続化方式（Phase 1限定）

Phase 1では完全な設定ファイル機能（REQ-CLI-001 F-012）は実装せず、以下の限定的な永続化を行う：

| 項目 | Phase 1実装 | Phase 2で拡張 |
|------|------------|--------------|
| サウンド設定 | `~/.pomodoro/sound-config.json` | `config.toml` に統合 |
| 設定読み込み | 起動時に読み込み | 同上 |
| 設定UI | `pomodoro config --work-sound/--break-sound` のみ | 完全な設定コマンド |

これにより、REQ-CLI-001 F-012（設定ファイル永続化）の完全実装はPhase 2のまま維持しつつ、本要件に必要な最小限の永続化を実現する。

**設定ファイル形式（Phase 1）**:
```json
{
  "work_end_sound": "Funk",
  "break_end_sound": "Glass"
}
```

**ビジネスルール（追加）**:
- BR-067: サウンド設定ファイルは `~/.pomodoro/sound-config.json` に保存
- BR-068: 設定ファイルが存在しない場合はデフォルト値を使用
- BR-069: 設定ファイルが破損している場合はデフォルト値にフォールバックし、警告を出力

---

## 6. 外部インターフェース

### 6.1 macOSシステムサウンド

| 項目 | 内容 |
|------|------|
| パス | `/System/Library/Sounds/` |
| フォーマット | AIFF (.aiff) |
| 読み込み方式 | rodioの `Decoder` を使用 |

**利用可能なサウンド一覧（macOS標準）**:

| サウンド名 | 特性 | 推奨用途 |
|-----------|------|---------|
| Basso | 低音、穏やか | 休憩終了 |
| Blow | 風の音 | 休憩終了 |
| Bottle | 瓶の音 | - |
| Frog | カエルの鳴き声 | - |
| Funk | ファンキー、リズミカル | 作業終了 |
| Glass | ガラスの音、クリア | 休憩終了 |
| Hero | ヒーロー登場風 | 作業終了 |
| Morse | モールス信号 | - |
| Ping | 短いピング音 | 作業終了 |
| Pop | ポップ音 | 作業終了 |
| Purr | 猫のゴロゴロ音 | 休憩終了 |
| Sosumi | 短いアラート | 作業終了 |
| Submarine | 潜水艦のソナー | - |
| Tink | 軽い金属音 | - |

---

## 7. 前提条件と依存関係

### 7.1 前提条件

- REQ-CLI-001の基本機能（F-004, F-021）が実装済み
- macOSシステムサウンドが `/System/Library/Sounds/` に存在する
- ターミナルがANSIエスケープシーケンスに対応している

### 7.2 依存関係

| 依存先 | 内容 | 影響 |
|--------|------|------|
| REQ-CLI-001 F-004 | 残り時間表示 | 本機能で拡張 |
| REQ-CLI-001 F-021 | システムサウンド | 本機能で拡張 |
| rodio クレート | サウンド再生 | AIFF対応必須 |
| colored クレート | 色分け表示 | 既存依存関係 |

---

## 8. リスクと課題

### 8.1 リスク一覧

| ID | リスク | 影響度 | 発生確率 | 対策 |
|----|--------|--------|---------|------|
| R-010 | macOSバージョンでサウンドパスが変更 | 中 | 低 | パス検出のフォールバック実装 |
| R-011 | rodioがAIFF形式を正しく再生できない | 高 | 低 | 事前検証、WAV変換フォールバック |
| R-012 | ターミナルで色が正しく表示されない | 中 | 中 | 色なしモードへのフォールバック |

### 8.2 未解決課題

| ID | 課題 | 担当 | 期限 | ステータス |
|----|------|------|------|----------|
| I-010 | rodioでAIFF形式の再生検証 | - | 2026-01-10 | 未着手 |
| I-011 | インジケーターデザインの最終決定 | - | 2026-01-08 | 未着手 |
| I-012 | 設定ファイル形式の決定（TOML vs JSON） | - | 2026-01-08 | **解決済み（JSON採用）** |
| I-013 | サウンド再生詳細設計書の更新 | - | 2026-01-10 | 未着手 |
| I-014 | CLIクライアント詳細設計書の更新 | - | 2026-01-10 | 未着手 |

---

## 9. 用語集

| 用語 | 定義 |
|------|------|
| インジケーター | 進捗状況を視覚的に表現する表示要素 |
| フェーズ | タイマーの状態（作業中、短い休憩、長い休憩） |
| システムサウンド | macOSに標準で含まれる効果音 |
| ANSIエスケープシーケンス | ターミナルで色やカーソル位置を制御する特殊文字列 |

---

## 10. 既存設計書への影響

本要件の実装に伴い、以下の設計書の更新が必要：

### 10.1 更新が必要な設計書

| 設計書 | パス | 更新内容 | 優先度 |
|--------|------|---------|--------|
| サウンド再生詳細設計 | `docs/designs/detailed/pomodoro-timer/sound-playback.md` | フェーズ別サウンド対応（SoundSource拡張、SoundConfig追加） | 高 |
| CLIクライアント詳細設計 | `docs/designs/detailed/pomodoro-timer/cli-client.md` | `sounds`/`config` コマンド追加 | 高 |
| 基本設計書 | `docs/designs/basic/BASIC-CLI-001_pomodoro-timer.md` | スコープ外リストの注記追加（サウンド設定のみPhase 1） | 低 |

### 10.2 サウンド再生詳細設計への追加内容

#### SoundConfig 構造体（新規）

```rust
/// サウンド設定
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SoundConfig {
    /// 作業終了時のサウンド名
    pub work_end_sound: String,
    /// 休憩終了時のサウンド名
    pub break_end_sound: String,
}

impl Default for SoundConfig {
    fn default() -> Self {
        Self {
            work_end_sound: "Funk".to_string(),
            break_end_sound: "Glass".to_string(),
        }
    }
}
```

#### SoundPlayer トレイトの拡張

```rust
#[async_trait::async_trait]
pub trait SoundPlayer: Send + Sync {
    /// フェーズに応じたサウンドを再生
    async fn play_for_phase(&self, phase: TimerPhase, config: &SoundConfig) -> Result<(), SoundError>;
    
    /// 利用可能なシステムサウンド一覧を取得
    fn list_available_sounds(&self) -> Vec<String>;
    
    /// サウンドが再生可能かチェック
    fn is_available(&self) -> bool;
}
```

### 10.3 CLIクライアント詳細設計への追加内容

#### 追加コマンド定義

```rust
#[derive(Subcommand, Debug)]
pub enum Commands {
    // ... 既存コマンド ...
    
    /// 利用可能なサウンド一覧を表示
    Sounds,
    
    /// 設定を表示・変更
    Config(ConfigArgs),
}

#[derive(Args, Debug)]
pub struct ConfigArgs {
    /// 作業終了サウンドを設定
    #[arg(long)]
    pub work_sound: Option<String>,
    
    /// 休憩終了サウンドを設定
    #[arg(long)]
    pub break_sound: Option<String>,
    
    /// 現在の設定を表示
    #[arg(long)]
    pub show: bool,
}
```

---

## 11. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|----------|--------|
| 1.0.0 | 2026-01-05 | 初版作成 | - |
| 1.1.0 | 2026-01-05 | 既存設計との整合性チェック結果を反映：スコープ拡張の前提条件追加、設定永続化方式（Phase 1限定）追加、既存設計書への影響セクション追加 | - |

---

## 付録A: コマンドリファレンス（追加分）

### サウンド関連コマンド

```bash
# 利用可能なサウンド一覧を表示
pomodoro sounds

# 作業終了サウンドを設定
pomodoro config --work-sound <サウンド名>

# 休憩終了サウンドを設定
pomodoro config --break-sound <サウンド名>

# 現在の設定を表示
pomodoro config --show

# サウンドを無効化してタイマー開始
pomodoro start --no-sound
```

### オプション一覧（追加分）

| オプション | 説明 | デフォルト値 |
|-----------|------|-------------|
| `--work-sound <名前>` | 作業終了サウンド | Funk |
| `--break-sound <名前>` | 休憩終了サウンド | Glass |

---

## 付録B: エラーコード一覧（追加分）

| コード | メッセージ | 原因 | 対処法 |
|--------|-----------|------|--------|
| E020 | サウンドファイルが見つかりません | 指定したサウンドが存在しない | `pomodoro sounds` で一覧を確認 |
| E021 | サウンドの再生に失敗しました | rodioエラー | システムサウンド設定を確認 |
| E022 | 無効なサウンド名です | 存在しないサウンド名を指定 | 正しいサウンド名を指定 |
