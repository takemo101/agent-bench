# 統合テスト仕様書

## メタ情報

| 項目 | 内容 |
|------|------|
| ドキュメントID | DETAIL-CLI-004-TEST |
| 親設計書 | [BASIC-CLI-004_visual-enhancement.md](../../../basic/BASIC-CLI-004_visual-enhancement.md) |
| 対応要件 | F-035, F-036, F-037 |
| バージョン | 1.0.0 |
| ステータス | ドラフト |
| 作成日 | 2026-01-10 |

---

## 1. 概要

### 1.1 目的

本テスト仕様書は、表示改善機能（F-035: 時間表示、F-036: アニメーション、F-037: 統合レイアウト）の品質を保証するためのテスト項目を定義する。

### 1.2 テストスコープ

| テスト種別 | 対象 | 自動化 |
|-----------|------|--------|
| 単体テスト | 各モジュールの関数・構造体 | Yes |
| 結合テスト | モジュール間の連携 | Yes |
| 視覚的確認テスト | ターミナル表示 | No（手動） |
| パフォーマンステスト | CPU負荷・メモリ使用量 | Yes |

---

## 2. 単体テスト仕様

### 2.1 TimeFormatter (time_format.rs)

| テストID | テスト名 | 入力 | 期待出力 | 優先度 |
|---------|---------|------|---------|--------|
| TF-001 | 通常の時間表示 | elapsed=323, total=1500 | "05:23/25:00 (21%)" | 高 |
| TF-002 | 開始直後 | elapsed=0, total=1500 | "00:00/25:00 (0%)" | 高 |
| TF-003 | 完了時 | elapsed=1500, total=1500 | "25:00/25:00 (100%)" | 高 |
| TF-004 | 超過時 | elapsed=1600, total=1500 | "26:40/25:00 (100%)" | 高 |
| TF-005 | 短い休憩 | elapsed=150, total=300 | "02:30/05:00 (50%)" | 中 |
| TF-006 | 長期休憩 | elapsed=450, total=900 | "07:30/15:00 (50%)" | 中 |
| TF-007 | total=0の場合 | elapsed=100, total=0 | "01:40/00:00 (0%)" | 高 |

### 2.2 AnimationEngine (animation.rs)

| テストID | テスト名 | 入力 | 期待出力 | 優先度 |
|---------|---------|------|---------|--------|
| AE-001 | 作業中フレーム取得 | phase=Working, counter=0 | WORK_FRAMES[0] | 高 |
| AE-002 | 作業中フレームループ | phase=Working, counter=4 | WORK_FRAMES[0] | 高 |
| AE-003 | 休憩中フレーム取得 | phase=Breaking, counter=0 | BREAK_FRAMES[0] | 高 |
| AE-004 | 長期休憩フレーム取得 | phase=LongBreaking, counter=0 | LONG_BREAK_FRAMES[0] | 高 |
| AE-005 | 一時停止時フレーム | phase=Paused, counter=0 | 固定フレーム | 中 |
| AE-006 | フレーム幅計算 | "🏃💨 ───" | unicode-widthで計算 | 高 |

### 2.3 LayoutRenderer (layout.rs)

| テストID | テスト名 | 入力 | 期待出力 | 優先度 |
|---------|---------|------|---------|--------|
| LR-001 | 3行レイアウト構築 | phase, time, frame, task | DisplayLayout(3行) | 高 |
| LR-002 | 2行レイアウト（タスクなし） | phase, time, frame, None | DisplayLayout(2行) | 高 |
| LR-003 | プログレスバー構築 | position=50, total=100 | "[████████░░░░░░░░]" | 高 |
| LR-004 | フェーズスタイル取得 | phase=Working | ("🍅", "作業中", "red") | 高 |
| LR-005 | ターミナル幅更新 | width=120 | bar_width=48 | 中 |

### 2.4 TerminalController (terminal.rs)

| テストID | テスト名 | 入力 | 期待出力 | 優先度 |
|---------|---------|------|---------|--------|
| TC-001 | ANSIシーケンス生成 | SaveCursor | "\x1b[s" | 高 |
| TC-002 | MoveUp生成 | MoveUp(3) | "\x1b[3A" | 高 |
| TC-003 | バッファ追加 | "hello" | buffer.len()=5 | 高 |
| TC-004 | TTY判定 | - | true/false | 中 |
| TC-005 | 非TTYフォールバック | layout | プレーンテキスト出力 | 高 |

---

## 3. 結合テスト仕様

### 3.1 TimeFormatter + LayoutRenderer

| テストID | テスト名 | シナリオ | 期待結果 | 優先度 |
|---------|---------|---------|---------|--------|
| INT-001 | 時間表示統合 | TimeDisplayを作成しbuild_layout()に渡す | line1に時間表示が含まれる | 高 |
| INT-002 | パーセンテージ反映 | elapsed=750, total=1500 | "50%"がline1に含まれる | 高 |

### 3.2 AnimationEngine + LayoutRenderer

| テストID | テスト名 | シナリオ | 期待結果 | 優先度 |
|---------|---------|---------|---------|--------|
| INT-003 | アニメーション統合 | AnimationFrameを作成しbuild_layout()に渡す | line2にアニメーションが含まれる | 高 |
| INT-004 | フェーズ切り替え | Working→Breaking | アニメーションが変更される | 高 |

### 3.3 LayoutRenderer + TerminalController

| テストID | テスト名 | シナリオ | 期待結果 | 優先度 |
|---------|---------|---------|---------|--------|
| INT-005 | レイアウトレンダリング | DisplayLayoutをrender()に渡す | 正常終了（io::Result::Ok） | 高 |
| INT-006 | 連続レンダリング | 同じレイアウトを5回render() | ちらつきなし（手動確認） | 高 |
| INT-007 | 行数変更 | 3行→2行→3行 | 正しくクリア・描画される | 高 |

---

## 4. 視覚的確認テスト仕様

### 4.1 対象ターミナル

| ターミナル | バージョン | 必須/推奨 |
|-----------|-----------|----------|
| iTerm2 | 3.5+ | 必須 |
| Terminal.app | macOS 11+ | 必須 |
| Alacritty | 0.13+ | 推奨 |

### 4.2 確認項目

| テストID | 確認項目 | 手順 | 合格基準 | 優先度 |
|---------|---------|------|---------|--------|
| VIS-001 | 初期表示 | pomodoro start実行 | 3行レイアウトが正しく表示 | 高 |
| VIS-002 | アニメーション動作 | 5秒間観察 | 200ms間隔でフレーム更新 | 高 |
| VIS-003 | ちらつき防止 | 1分間観察 | ちらつきなし | 高 |
| VIS-004 | フェーズ切り替え | 作業→休憩遷移 | アニメーション・色が変更 | 高 |
| VIS-005 | 絵文字表示 | 各フェーズ確認 | 🍅☕🛏️が正しく表示 | 高 |
| VIS-006 | 一時停止表示 | pomodoro pause実行 | ⏸️と一時停止表示 | 中 |
| VIS-007 | タスク名表示 | --taskオプション付き | 3行目にタスク名 | 中 |
| VIS-008 | タスク名なし | --taskなし | 2行表示 | 中 |
| VIS-009 | 長いタスク名 | 80文字以上のタスク名 | 切り詰めまたは折り返し | 低 |
| VIS-010 | ターミナルリサイズ | ウィンドウサイズ変更 | 表示が崩れない | 低 |

### 4.3 確認手順テンプレート

```markdown
## VIS-XXX: [確認項目]

### 事前条件
- [前提条件を記載]

### 手順
1. [ステップ1]
2. [ステップ2]
3. [ステップ3]

### 期待結果
- [期待される表示・動作]

### 確認結果
- [ ] iTerm2: PASS / FAIL
- [ ] Terminal.app: PASS / FAIL
- [ ] Alacritty: PASS / FAIL

### 備考
- [特記事項があれば記載]
```

---

## 5. パフォーマンステスト仕様

### 5.1 測定項目

| テストID | 測定項目 | 目標値 | 測定方法 |
|---------|---------|--------|---------|
| PERF-001 | format()実行時間 | 1μs以内 | criterion |
| PERF-002 | get_frame()実行時間 | 100ns以内 | criterion |
| PERF-003 | build_layout()実行時間 | 10μs以内 | criterion |
| PERF-004 | render()実行時間 | 1ms以内 | criterion |
| PERF-005 | CPU使用率（アニメーション中） | 1%以下 | top/Activity Monitor |
| PERF-006 | メモリ追加使用量 | 1MB以下 | dhat |

### 5.2 ベンチマーク実行

```bash
# criterionベンチマーク実行
cargo bench --bench visual_enhancement

# メモリプロファイリング
cargo run --features dhat-heap --bin pomodoro -- start
```

### 5.3 負荷テスト

| テストID | シナリオ | 継続時間 | 合格基準 |
|---------|---------|---------|---------|
| LOAD-001 | 25分間連続動作 | 25分 | メモリリーク・CPU上昇なし |
| LOAD-002 | 4ポモドーロサイクル | 約2時間 | 安定動作 |

---

## 6. 回帰テスト

### 6.1 既存機能との互換性

| テストID | 確認項目 | 影響する機能 | 確認方法 |
|---------|---------|-------------|---------|
| REG-001 | pomodoro start | F-001 | コマンド実行、タイマー開始確認 |
| REG-002 | pomodoro status | F-007 | 状態表示が正常 |
| REG-003 | pomodoro pause/resume | F-003, F-004 | 一時停止・再開が正常 |
| REG-004 | pomodoro stop | F-005 | 停止が正常 |
| REG-005 | 通知機能 | F-013 | フェーズ完了時に通知 |
| REG-006 | サウンド再生 | F-018 | フェーズ完了時にサウンド |

---

## 7. テスト環境

### 7.1 必須環境

| 項目 | 要件 |
|------|------|
| OS | macOS 11.0 (Big Sur) 以上 |
| Rust | 1.71 以上 |
| ターミナル | ANSI対応、Unicode対応 |

### 7.2 テストデータ

| データ名 | 内容 | 用途 |
|---------|------|------|
| 短い作業 | 5分（300秒） | 短時間テスト |
| 標準作業 | 25分（1500秒） | 通常テスト |
| 長期休憩 | 15分（900秒） | 長期休憩テスト |

---

## 8. テスト実行計画

### 8.1 実行順序

1. 単体テスト（cargo test）
2. 結合テスト（cargo test --test integration）
3. パフォーマンステスト（cargo bench）
4. 視覚的確認テスト（手動）
5. 回帰テスト（既存テストスイート実行）

### 8.2 CI/CD統合

```yaml
# .github/workflows/test.yml に追加
- name: Run visual enhancement tests
  run: cargo test --features visual-enhancement

- name: Run benchmarks
  run: cargo bench --bench visual_enhancement -- --noplot
```

---

## 9. 合格基準

| 種別 | 合格基準 |
|------|---------|
| 単体テスト | 100%パス |
| 結合テスト | 100%パス |
| 視覚的確認テスト | VIS-001〜VIS-008すべてPASS |
| パフォーマンステスト | 全目標値達成 |
| 回帰テスト | 100%パス |

---

## 10. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| 2026-01-10 | 1.0.0 | 初版作成 | - |
