# イベントフック機能 セキュリティ設計書

## 1. 概要

イベントフック機能では、ユーザー定義のBashスクリプトを実行するため、セキュリティリスクが存在する。本設計書では、これらのリスクを軽減するためのセキュリティ対策を定義する。

## 2. セキュリティ要件

### 2.1 要件一覧

| 要件ID | 要件 | 詳細 | 優先度 |
|--------|------|------|--------|
| NFR-S-010 | スクリプトパス検証 | 絶対パスのみ許可、相対パスは拒否 | 必須 |
| NFR-S-011 | 実行権限確認 | スクリプトファイルの実行権限を確認 | 必須 |
| NFR-S-012 | 環境変数サニタイズ | 環境変数の値をエスケープ処理 | 必須 |
| NFR-S-013 | ログファイル権限 | ログファイルは0600（所有者のみ読み書き可） | 必須 |
| NFR-S-014 | 設定ファイル権限 | 設定ファイルは0600推奨（警告のみ） | 重要 |

## 3. 脅威モデル

### 3.1 脅威一覧

| 脅威ID | 脅威 | 影響度 | 発生確率 | 対策 |
|--------|------|--------|---------|------|
| T-001 | パストラバーサル攻撃 | 高 | 中 | 絶対パスのみ許可 |
| T-002 | コマンドインジェクション | 高 | 低 | 環境変数のエスケープ |
| T-003 | 権限昇格 | 高 | 低 | ユーザー権限で実行 |
| T-004 | 情報漏洩（ログ） | 中 | 中 | ログファイル権限0600 |
| T-005 | 設定ファイル改ざん | 中 | 低 | 権限チェック、警告 |
| T-006 | 無限ループ | 中 | 中 | タイムアウト制御 |

### 3.2 攻撃シナリオと対策

#### T-001: パストラバーサル攻撃

**攻撃シナリオ**:
```json
{
  "hooks": {
    "work_end": [
      {
        "name": "悪意のあるスクリプト",
        "script": "../../../tmp/malicious.sh",
        "enabled": true
      }
    ]
  }
}
```

**対策**:
```rust
// スクリプトパスは絶対パスのみ許可
if !script_path.is_absolute() {
    anyhow::bail!("スクリプトパスは絶対パスである必要があります");
}
```

#### T-002: コマンドインジェクション

**攻撃シナリオ**:
```bash
# 環境変数にコマンドインジェクション
POMODORO_TASK="; rm -rf /"
```

**対策**:
```rust
/// 環境変数の値をサニタイズ
fn sanitize_env_value(value: &str) -> String {
    value
        .replace('$', "\\$")
        .replace('`', "\\`")
        .replace('\\', "\\\\")
        .replace('"', "\\\"")
}
```

#### T-003: 権限昇格

**対策**:
- スクリプトはユーザー権限で実行（sudoは使用しない）
- 実行権限の確認（0o111ビット）

```rust
#[cfg(unix)]
{
    use std::os::unix::fs::PermissionsExt;
    let mode = metadata.permissions().mode();
    if mode & 0o111 == 0 {
        anyhow::bail!("スクリプトに実行権限がありません");
    }
}
```

## 4. セキュリティ対策の実装

### 4.1 スクリプトパス検証

```rust
/// スクリプトパスの検証
///
/// # セキュリティチェック
/// 1. 絶対パスであること（パストラバーサル攻撃防止）
/// 2. ファイルが存在すること
/// 3. 実行権限があること
fn validate_script(script_path: &PathBuf) -> Result<()> {
    // 1. 絶対パスチェック（パストラバーサル攻撃防止）
    if !script_path.is_absolute() {
        anyhow::bail!(
            "セキュリティエラー: スクリプトパスは絶対パスである必要があります: {:?}",
            script_path
        );
    }
    
    // 2. ファイル存在チェック
    if !script_path.exists() {
        anyhow::bail!("スクリプトファイルが見つかりません: {:?}", script_path);
    }
    
    // 3. 実行権限チェック（Unix系のみ）
    #[cfg(unix)]
    {
        use std::os::unix::fs::PermissionsExt;
        
        let metadata = std::fs::metadata(script_path)
            .context("スクリプトファイルのメタデータ取得に失敗")?;
        
        let permissions = metadata.permissions();
        let mode = permissions.mode();
        
        // 実行権限ビット（0o111）をチェック
        if mode & 0o111 == 0 {
            anyhow::bail!(
                "セキュリティエラー: スクリプトに実行権限がありません: {:?}",
                script_path
            );
        }
    }
    
    Ok(())
}
```

### 4.2 環境変数サニタイズ

```rust
/// 環境変数の値をサニタイズ
///
/// # セキュリティ対策
/// - コマンドインジェクション防止
/// - シェル特殊文字のエスケープ
fn sanitize_env_value(value: &str) -> String {
    value
        .replace('\\', "\\\\")  // バックスラッシュ
        .replace('$', "\\$")    // 変数展開
        .replace('`', "\\`")    // コマンド置換
        .replace('"', "\\\"")   // ダブルクォート
        .replace('!', "\\!")    // ヒストリ展開
        .replace('\n', "\\n")   // 改行
        .replace('\r', "\\r")   // キャリッジリターン
}

impl HookContext {
    /// 環境変数のマップを生成（サニタイズ済み）
    pub fn to_env_vars(&self) -> HashMap<String, String> {
        let mut env = HashMap::new();
        
        env.insert("POMODORO_EVENT".to_string(), self.event.as_str().to_string());
        env.insert("POMODORO_PHASE".to_string(), self.phase.as_str().to_string());
        
        // タスク名はサニタイズ
        if let Some(task) = &self.task_name {
            env.insert("POMODORO_TASK_NAME".to_string(), sanitize_env_value(task));
        }
        
        // 数値はそのまま（サニタイズ不要）
        env.insert("POMODORO_DURATION_SECS".to_string(), self.duration_secs.to_string());
        env.insert("POMODORO_ELAPSED_SECS".to_string(), self.elapsed_secs.to_string());
        env.insert("POMODORO_REMAINING_SECS".to_string(), self.remaining_secs.to_string());
        env.insert("POMODORO_CYCLE".to_string(), self.cycle.to_string());
        env.insert("POMODORO_TOTAL_CYCLES".to_string(), self.total_cycles.to_string());
        
        // タイムスタンプ、UUIDはサニタイズ不要（フォーマット固定）
        env.insert("POMODORO_TIMESTAMP".to_string(), self.timestamp.to_rfc3339());
        env.insert("POMODORO_SESSION_ID".to_string(), self.session_id.to_string());
        
        env
    }
}
```

### 4.3 ログファイル権限

```rust
/// ログファイルを作成（権限0600）
fn create_log_file() -> Result<()> {
    let log_dir = dirs::home_dir()
        .expect("ホームディレクトリが取得できません")
        .join(".pomodoro")
        .join("logs");
    
    // ログディレクトリ作成
    std::fs::create_dir_all(&log_dir)
        .context("ログディレクトリの作成に失敗")?;
    
    let log_file = log_dir.join("hooks.log");
    
    // ログファイル作成
    std::fs::File::create(&log_file)
        .context("ログファイルの作成に失敗")?;
    
    // 権限を0600に設定（所有者のみ読み書き可）
    #[cfg(unix)]
    {
        use std::os::unix::fs::PermissionsExt;
        let permissions = std::fs::Permissions::from_mode(0o600);
        std::fs::set_permissions(&log_file, permissions)
            .context("ログファイルの権限設定に失敗")?;
    }
    
    Ok(())
}
```

### 4.4 設定ファイル権限チェック

```rust
/// 設定ファイルの権限をチェック（警告のみ）
fn check_config_file_permissions(config_path: &Path) {
    #[cfg(unix)]
    {
        use std::os::unix::fs::PermissionsExt;
        
        if let Ok(metadata) = std::fs::metadata(config_path) {
            let permissions = metadata.permissions();
            let mode = permissions.mode();
            
            // 0600以外の場合は警告
            if mode & 0o777 != 0o600 {
                tracing::warn!(
                    "セキュリティ警告: フック設定ファイルの権限が0600ではありません: {:?} (現在: {:o})",
                    config_path,
                    mode & 0o777
                );
                tracing::warn!(
                    "推奨: chmod 600 {:?}",
                    config_path
                );
            }
        }
    }
}
```

## 5. セキュリティベストプラクティス

### 5.1 ユーザー向けガイドライン

#### スクリプト作成時の注意事項

1. **スクリプトは絶対パスで指定**
   ```json
   {
     "script": "/Users/user/.pomodoro/scripts/notify.sh"  // OK
     "script": "~/scripts/notify.sh"                       // NG
     "script": "./notify.sh"                               // NG
   }
   ```

2. **スクリプトに実行権限を付与**
   ```bash
   chmod +x /Users/user/.pomodoro/scripts/notify.sh
   ```

3. **設定ファイルの権限を制限**
   ```bash
   chmod 600 ~/.pomodoro/hooks.json
   ```

4. **環境変数の値を信頼しない**
   ```bash
   # NG: 環境変数を直接evalしない
   eval "$POMODORO_TASK_NAME"
   
   # OK: 環境変数をクォートで囲む
   echo "Task: $POMODORO_TASK_NAME"
   ```

### 5.2 開発者向けガイドライン

1. **すべての外部入力を検証**
   - スクリプトパス
   - フック名
   - タイムアウト値

2. **最小権限の原則**
   - スクリプトはユーザー権限で実行
   - sudoは使用しない

3. **エラーメッセージに機密情報を含めない**
   ```rust
   // NG: パスワードが含まれる可能性
   tracing::error!("エラー: {:?}", full_error);
   
   // OK: 必要最小限の情報のみ
   tracing::error!("スクリプト実行エラー: {}", error.to_string());
   ```

4. **ログローテーション**
   - ログファイルは最大10MBまで
   - 古いログは自動削除

## 6. セキュリティテスト

### 6.1 テスト項目

| テストID | テスト内容 | 期待結果 |
|---------|-----------|---------|
| SEC-001 | 相対パスのスクリプトを登録 | エラー、フック機能無効化 |
| SEC-002 | 実行権限のないスクリプトを登録 | エラー、該当フックをスキップ |
| SEC-003 | 環境変数にコマンドインジェクション | エスケープされて安全に実行 |
| SEC-004 | ログファイルの権限確認 | 0600（所有者のみ読み書き可） |
| SEC-005 | 設定ファイルの権限が0644の場合 | 警告ログ出力、動作は継続 |

### 6.2 テストコード例

```rust
#[test]
fn test_validate_script_relative_path() {
    let path = PathBuf::from("./malicious.sh");
    let result = validate_script(&path);
    assert!(result.is_err());
    assert!(result.unwrap_err().to_string().contains("絶対パス"));
}

#[test]
fn test_sanitize_env_value() {
    let malicious = "; rm -rf /";
    let sanitized = sanitize_env_value(malicious);
    assert!(!sanitized.contains(';'));
}
```

## 7. インシデント対応

### 7.1 セキュリティインシデント発生時の対応

1. **検知**
   - ログファイルの異常なエラー
   - 予期しないプロセスの実行

2. **初動対応**
   - フック機能を無効化（`enabled: false`）
   - 設定ファイルのバックアップ
   - ログファイルの保存

3. **調査**
   - ログファイルの解析
   - スクリプトファイルの確認
   - 設定ファイルの確認

4. **復旧**
   - 問題のあるスクリプトの削除
   - 設定ファイルの修正
   - フック機能の再有効化

## 8. 監査ログ

### 8.1 ログ記録項目

| 項目 | 記録内容 | ログレベル |
|------|---------|-----------|
| フック実行開始 | イベント名、フック名、タイムスタンプ | INFO |
| フック実行成功 | フック名、実行時間 | INFO |
| フック実行失敗 | フック名、エラー内容 | ERROR |
| タイムアウト | フック名、タイムアウト時間 | ERROR |
| バリデーションエラー | スクリプトパス、エラー内容 | ERROR |
| 設定ファイル読み込み | ファイルパス、フック数 | INFO |
| 設定ファイルエラー | ファイルパス、エラー内容 | WARN |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|:---|:---|:---|:---|
| 2026-01-06 | 1.0.0 | 初版作成 | - |
