# Subtask実装ルール（トークン最適化版）

> **目的**: implement-issues.mdから詳細ルールを分離し、トークン消費を削減する。
> container-workerはこのスキルを参照して実装する。

---

## 1. 設計書参照ルール

### 絶対禁止: 設計書の全文読み込み

| 実装内容 | 読むべきセクション | 上限 |
|---------|------------------|------|
| データ型定義 | `## データ型`, `## インターフェース` | 2,000トークン |
| API実装 | `## エンドポイント`, `## リクエスト/レスポンス` | 2,000トークン |
| UI実装 | `## 画面仕様`, `## コンポーネント` | 2,000トークン |
| DB関連 | `## テーブル定義`, `## マイグレーション` | 2,000トークン |
| テスト | `## テストケース`, `## 境界条件` | 2,000トークン |

### 参照手順（具体的なツール操作）

```python
# Step 1: 目次のみ確認（50行）
outline = read(design_path, limit=50)

# Step 2: 対象セクションの行番号を特定
grep_result = grep(path=design_path, pattern="## データ型")
# 結果例: line 45 にマッチ

# Step 3: 該当部分のみピンポイントで読み込み
section_content = read(design_path, offset=44, limit=80)
# offset=行番号-1, limit=セクション想定行数

# ⛔ 禁止: read(design_path) での全文読み込み
# ⛔ 禁止: limit指定なしでの読み込み
```

**なぜ重要か**: 全文読み込みは5,000〜20,000トークンを消費。セクション単位なら500〜2,000トークンで済む。

---

## 2. 粒度ルール

| 項目 | 上限 | 違反時 |
|------|------|--------|
| コード量 | 200行 | 即時中断、親に報告 |
| ファイル数 | 3ファイル | 即時中断、親に報告 |
| リトライ | 3回 | Draft PR作成 |

---

## 3. TDDフロー

```
🔴 Red: テスト作成 → 失敗確認
    ↓
🟢 Green: 最小実装 → 成功確認
    ↓
🔵 Refactor: 整形 → 再テスト
```

---

## 4. 品質レビュー

| スコア | アクション |
|--------|----------|
| 9-10点 | PR作成へ |
| 7-8点 | 修正 → 再レビュー |
| 6点以下 | 報告 → 設計見直し |

### レビュー観点（5項目）
1. 設計書との整合性
2. コード品質（SOLID、命名）
3. エラーハンドリング
4. テストカバレッジ
5. セキュリティ

---

## 5. 出力形式（必須）

### 成功時（最小JSON）

```json
{
  "subtask_id": N,
  "pr_number": N,
  "env_id": "xxx",
  "score": N,
  "status": "success"
}
```

### 失敗時

```json
{
  "subtask_id": N,
  "env_id": "xxx",
  "status": "failed",
  "error": "簡潔なエラー説明"
}
```

---

## 6. 禁止事項

| 禁止 | 代替 |
|------|------|
| ホストで `edit`/`write` | `environment_file_write` |
| ホストで `bash cargo test` | `environment_run_cmd` |
| 設計書全文読み込み | セクション単位参照 |
| レビュースキップ | 必ず実行 |
| 冗長な出力 | 最小JSON形式 |

---

## 7. プラットフォーム例外

macOS専用API（`objc2`, `cocoa`等）使用時のみホスト環境を許可。
必ず報告してから作業開始。

---

## 8. 撤退条件（必ず守る）

| 状況 | アクション |
|------|----------|
| 環境作成が3回失敗 | 中断、Sisyphusに報告 |
| テストが10回連続失敗 | 中断、設計見直し要請 |
| レビュー3回失敗 | Draft PR作成、中断 |
| 200行超過の見込み | 即時中断、粒度違反報告 |
| 1時間経過 | 進捗報告、継続可否確認 |

**⛔ 絶対禁止**: 無限ループ、エンドレスリトライ
