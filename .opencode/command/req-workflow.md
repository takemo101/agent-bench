---
description: コンテキストから要件定義書作成→レビュー→承認までの完全ワークフロー
---

## 要件定義完全ワークフロー

このコマンドは以下のフェーズを実行します：
1. コンテキスト収集
2. 要件定義書作成
3. レビュー・修正ループ（8点以上まで）
4. **ユーザー承認ゲート**（続行/修正/中断を選択）
5. 成果物サマリー

## 入力

$ARGUMENTS

### 入力形式

以下の形式で入力を受け付けます：

```
プロジェクト: [プロジェクト名・概要]
ビジネス: [ビジネス目標・KPI]
ユーザー: [ターゲットユーザー・課題]
技術: [技術制約・既存システム]
メモ: [参照するメモのパス（任意）]
```

**入力例:**
```
プロジェクト: タスク管理システムの新規開発
ビジネス: チーム生産性向上、進捗可視化
ユーザー: 開発チーム、プロジェクトマネージャー
技術: Next.js、既存の認証基盤と連携必須
メモ: docs/memos/task-management-idea.md
```

**簡易入力（プロジェクト概要のみ）:**
```
ユーザー管理機能を持つWebアプリケーションを作りたい
```

---

### Phase 0: コンテキスト収集

入力から参照先を解析し、必要な情報を収集

**実行内容:**
1. 入力から要件の種類・規模を判断
2. 指定されたメモファイルを読み込み
3. `docs/memos/` ディレクトリを自動チェック
4. `docs/requirements/` の既存要件定義書を確認
5. プロジェクト構成（package.json等）を把握
6. 収集した情報を整理

---

### Phase 0.5: 既存要件との整合性確認【追加仕様時必須】

> **トリガー**: `docs/requirements/` に既存の要件定義書が存在する場合

**目的**: 追加仕様が既存要件と矛盾しないことを確認し、影響範囲を特定する。

**実行内容:**

1. **既存要件定義書の特定**:
   - `docs/requirements/REQ-*.md` を検索
   - 関連する要件定義書を特定（同一プロジェクト/機能領域）

2. **整合性チェック項目**:

   | チェック項目 | 確認内容 | 矛盾時のアクション |
   |-------------|---------|------------------|
   | 機能ID重複 | 新規F-XXXが既存と重複しないか | 連番を調整 |
   | 用語定義 | 同一用語が異なる意味で使われていないか | 用語集を統一 |
   | 技術制約 | 既存の技術制約と矛盾しないか | 制約の優先順位を明記 |
   | 非機能要件 | パフォーマンス/セキュリティ要件が矛盾しないか | 厳しい方を採用 |
   | スコープ境界 | 既存のスコープ外項目と重複しないか | スコープ変更を明記 |

3. **影響分析レポート作成**:

   ```markdown
   ## 既存要件との整合性チェック結果
   
   ### 関連する既存要件定義書
   | ドキュメント | 関連度 | 影響 |
   |-------------|--------|------|
   | REQ-XXX-001_既存機能.md | 高 | 機能追加 |
   
   ### 整合性チェック結果
   | 項目 | ステータス | 備考 |
   |------|----------|------|
   | 機能ID | ✅ OK | F-024から連番開始 |
   | 用語定義 | ✅ OK | 既存用語集と整合 |
   | 技術制約 | ⚠️ 要確認 | 依存バージョンの確認が必要 |
   
   ### 既存要件への影響
   - REQ-XXX-001 の機能一覧に追記が必要
   - または新規要件定義書 REQ-XXX-002 として独立作成
   ```

4. **ユーザー確認（影響がある場合）**:

   ```markdown
   ⚠️ 既存要件への影響が検出されました。
   
   **対応方針を選択してください**:
   - `追記` → 既存要件定義書（REQ-XXX-001）に追記
   - `新規` → 新規要件定義書（REQ-XXX-002）として作成
   - `中断` → 確認後に再開
   ```

**スキップ条件:**
- `docs/requirements/` に既存要件定義書が存在しない（新規プロジェクト）
- ユーザーから「新規要件として作成」と明示的に指示された場合

**完了条件:**
- 既存要件との整合性チェックが完了
- 影響がある場合はユーザー確認済み
- 作成方針（追記 or 新規）が決定

**収集する情報:**

| カテゴリ | 収集内容 |
|---------|---------|
| ビジネス | 目的、ゴール、KPI、予算、スケジュール |
| ユーザー | ペルソナ、課題、ニーズ、利用シーン |
| 技術 | 技術スタック、制約、既存システム |
| 競合 | 競合サービス、差別化ポイント |
| 法規制 | コンプライアンス要件 |

**【重要】技術スタック完全性チェック:**

以下の技術スタックが定義されているか確認し、未定義の場合は未解決課題として記録する：

| レイヤー | 必須/推奨 | 未定義時のアクション |
|---------|----------|---------------------|
| フロントエンド | 必須 | 未解決課題に追加（例: I-XXX フロントエンド技術選定） |
| バックエンド | 必須 | 未解決課題に追加 |
| データベース | 必須 | 未解決課題に追加 |
| 認証方式 | 必須 | 未解決課題に追加 |
| インフラ/クラウド | 推奨 | 備考として記載 |
| CI/CD | 推奨 | 備考として記載 |

> **注意**: 技術スタックが未定義の場合、**仮定で埋めずに「要選定（I-XXX）」と明記**すること。

**完了条件:**
- コンテキスト情報が整理されている
- 技術スタック完全性チェックが実施されている

---

### Phase 1: 要件定義書作成

@req-writer を使用して要件定義書を作成

**実行内容:**
- 収集したコンテキストを活用
- 入力情報を分析
- テンプレートに従って要件定義書を作成（日本語）
- `docs/requirements/REQ-[カテゴリ]-[連番]_[プロジェクト名].md` に保存

**コンテキストの活用:**
- ビジネス要件を「目的・ゴール」に反映
- ユーザー情報を「ペルソナ」「ユーザーストーリー」に反映
- 技術制約を「制約条件」「非機能要件」に反映
- 不明点は「未解決課題」に記載

**完了条件:**
- 要件定義書ファイルが作成されている
- 必須セクションがすべて記載されている

---

### Phase 2: レビュー・修正ループ

@req-reviewer と @req-writer を使用してレビューと修正を繰り返す

**実行内容:**
```
loop (最大5回):
    1. req-reviewerでレビュー実行
    2. スコアが8点以上なら終了
    3. req-writerで問題点を修正
    4. ループ継続
```

**完了条件:**
- スコアが8点以上
- または5回ループ完了

> **Note**: 要件定義は最大**5回**リトライ（設計/実装の3回より多い）
> 
> **理由**: 要件定義は後工程の土台となるため、ここでの品質確保が最重要。
> ステークホルダーとの認識齟齬を解消するために、より多くの修正機会を確保。
> また、要件の曖昧さは設計・実装フェーズで増幅されるため、
> 初期段階での徹底的な精査が全体コストを削減する。

---

### Phase 2.5: ユーザー承認ゲート【必須】

> **共通仕様**: {{skill:approval-gate}} を参照

**目的**: レビューループ完了後、成果物サマリーを出す前にユーザーの明示的な承認を得る。

**出力形式**:

```markdown
---
## 🔔 承認リクエスト: 要件定義書レビュー完了

### レビュー結果サマリー
| 項目 | 結果 |
|------|------|
| 最終スコア | X/10点 |
| レビュー回数 | Y回 |
| 合格基準 | 8点以上 ✅ |

### 要件定義書
- **パス**: `docs/requirements/REQ-XXX-NNN_機能名.md`

### 機能一覧（抜粋）
| ID | 機能名 | 優先度 |
|----|--------|--------|
| F-001 | [機能名] | 必須 |
| F-002 | [機能名] | 重要 |

### 未解決課題（あれば）
| ID | 課題 | 対応方針 |
|----|------|---------|
| I-XXX | [課題] | [方針] |

---
**次のアクション**: 成果物サマリー出力 → 基本設計へ

⏸️ **承認待ち**: 続行してよろしいですか？
- `続行` → 成果物サマリーを出力し、基本設計への準備完了
- `修正` → 指摘箇所を修正
- `中断` → ワークフローを終了
---
```

**重要**: ユーザーからの明示的な応答があるまで次のフェーズに進んではならない。

---

### Phase 3: 成果物サマリー

レビュー合格後、成果物をまとめて報告

**実行内容:**
- 要件定義書の概要をまとめる
- 機能一覧を抽出
- 次のステップを提示

---

## 最終出力

```markdown
## ワークフロー完了報告

### 実行サマリー
| フェーズ | ステータス | 詳細 |
|---------|-----------|------|
| コンテキスト収集 | 完了 | X件の情報源を参照 |
| 要件定義書作成 | 完了 | [ファイルパス] |
| レビューループ | 完了 | X回実行, 最終スコア: X/10 |

### 収集したコンテキスト
| 種類 | ソース | 主な内容 |
|------|--------|---------|
| ビジネス | 入力情報 | [概要] |
| ユーザー | 入力情報 | [概要] |
| メモ | docs/memos/xxx.md | [概要] |

### 成果物
#### 要件定義書
- パス: docs/requirements/REQ-XXX-001_xxx.md
- 最終スコア: X/10点

#### 機能一覧
| ID | 機能名 | 優先度 | フェーズ |
|----|--------|--------|---------|
| F-001 | [機能名] | 必須 | Phase 1 |
| F-002 | [機能名] | 重要 | Phase 1 |

### レビュースコア推移
| 回 | スコア | 主な改善点 |
|----|--------|-----------|
| 1  | X/10   | ... |
| 2  | X/10   | ... |

### 未解決課題
| ID | 課題 | 対応方針 |
|----|------|---------|
| I-001 | [課題] | [方針] |

### 次のステップ
1. ステークホルダーによる要件定義書の承認
2. 基本設計書の作成（`/basic-design-workflow` を使用）
3. 詳細設計書の作成（`/detailed-design-workflow` を使用）
4. 開発計画の策定
```

## エラーハンドリング

- **フェーズ0失敗**: メモが見つからない場合は入力情報のみで続行
- **フェーズ1失敗**: 入力情報の不足を報告し、追加情報を要求
- **フェーズ2で5回ループ後も8点未満**: 現状の問題点をまとめて報告、手動修正を推奨

## 全体フロー図

```
[入力] コンテキスト情報
    ↓
[Phase 0] コンテキスト収集
    ├── メモ読み込み
    ├── 既存ドキュメント確認
    └── プロジェクト構成把握
    ↓
[Phase 0.5] 既存要件との整合性確認 ★追加仕様時
    ├── 関連要件定義書の特定
    ├── 整合性チェック（機能ID/用語/技術制約）
    ├── 影響分析レポート作成
    └── ⏸️ 追記/新規/中断 を選択
    ↓
[Phase 1] 要件定義書作成
    └── @req-writer
    ↓
[Phase 2] レビュー・修正ループ
    ├── @req-reviewer → スコア判定
    └── @req-writer → 修正
    ↓ (8点以上)
[Phase 2.5] ユーザー承認ゲート
    └── ⏸️ 続行/修正/中断 を待機
    ↓ (続行)
[Phase 3] 成果物サマリー
    ↓
[出力] 完了報告
```
